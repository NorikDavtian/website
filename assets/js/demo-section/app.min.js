angular.module("darthGraph",["ui.ace","ui.bootstrap"]).controller("GraphMagic",["$scope","$http",function(a,f){a.examples=[{title:"Film Director",sample_code:"{\n  debug(_xid_: m.06pj8) {\n    type.object.name.en\n    film.director.film {\n      type.object.name.en\n      film.film.initial_release_date\n      film.film.country\n      film.film.starring {\n        film.performance.actor {\n          type.object.name.en\n        }\n        film.performance.character {\n          type.object.name.en\n        }\n      }\n      film.film.genre {\n        type.object.name.en\n      }\n    }\n  }\n}\n"},
{title:"Actor",sample_code:"{\n  debug(_xid_: m.0bxtg) {\n    type.object.name.en\n    film.actor.film {\n      film.performance.film {\n        type.object.name.en\n        type.object.name.ru\n      }\n    }\n  }\n}\n"},{title:"Movie",sample_code:"{\n  debug(_xid_: m.07bwr) {\n    type.object.name.en\n    film.film.initial_release_date\n    film.film.country\n    film.film.starring {\n      film.performance.actor {\n        type.object.name.en\n      }\n      film.performance.character {\n        type.object.name.en\n      }\n    }\n    film.film.genre {\n      type.object.name.en\n    }\n  }\n}\n"}];
a.active_tab=null;a.activate=function(b){a.active_tab&&(a.active_tab.active=!1);a.active_tab=a.examples[b];a.active_tab.code=a.active_tab.code||a.active_tab.sample_code;a.active_tab.active=!0};a.activate(0);a.reset_example_code=function(){a.active_tab.code=a.active_tab.sample_code};a.$watch("active_tab.code",function(b){a.runQuery(b)});a.isNetPending=function(){return a.lastSentVersion!=a.lastReceivedVersion};a.queryEditorLoaded=function(a){a.$blockScrolling=Infinity;a.session.setOptions({mode:"ace/mode/graphql",
tabSize:2,useSoftTabs:!0});a.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!0})};a.responseEditorLoaded=function(a){a.$blockScrolling=Infinity};a.typeahead_cache=[];a.typeahead_cache_indices={};a.found_entity=function(b){var c=a.typeahead_cache_indices[b.name];void 0==c?(a.typeahead_cache_indices[b.name]=a.typeahead_cache.length,a.typeahead_cache.push(b)):(c=a.typeahead_cache[c],c.xid=c.xid||b.xid,c.uid=c.uid||b.uid)};a.flush_typeahead_cache=function(){a.typeahead_cache=[];a.typeahead_cache_indices=
{};a.found_entity({name:"Steven Spielberg",xid:"m.06pj8",uid:"0x3b0de646eaf32b75"});a.found_entity({name:"Tom Hanks",xid:"m.0bxtg",uid:"0xcbcefccffb9eb400"});a.found_entity({name:"The Big Lebowski",xid:"m.07bwr",uid:"0xff4c6752867d137d"})};a.flush_typeahead_cache();a.$watch("typeahead_root_id",function(b){if(b&&(b=a.typeahead_cache[a.typeahead_cache_indices[b]])){var c=b.xid?"_xid_: "+b.xid:"_uid_: "+b.uid,d=a.active_tab.code.replace(/debug\s*\([^()]+\)/,"debug("+c+")");d==a.active_tab.code&&0>d.indexOf(c)&&
alert('Your query must contain string "debug(_xid_: <some id>) for autocomplete to work"');a.active_tab.code=d;1E5<a.typeahead_cache.length&&(a.flush_typeahead_cache(),a.found_entity(b))}});a.fetch_kg=function(b){return f.get("https://kgsearch.googleapis.com/v1/entities:search",{params:{key:"AIzaSyAiTPA51qB8hwBsbIt99Lwka0zo3z_0vQk",limit:200,types:["Person","Movie"],query:b}}).then(function(b){if(!b.data||!b.data.itemListElement)return[];var d=[];b.data.itemListElement.forEach(function(b){b={name:b.result.name,
xid:b.result["@id"].substr(4).replace("/",".")};a.found_entity(b);d.push(b)});return d})};a.$watch("active_tab.code",function(b){if(b){var c=b.match(/me\s*\(\s*_xid_\s*:\s*([^\s]*)\s*\)/);c&&c[1]?a.entity_selected("xid",c[1]):(b=b.match(/me\s*\(\s*_uid_\s*:\s*([^\s]*)\s*\)/))&&b[1]&&a.entity_selected("uid",b[1])}});a.entity_selected=function(b,c){for(var d=0;d<a.typeahead_cache.length;d++)if(a.typeahead_cache[d][b]==c){a.typeahead_root_id=a.typeahead_cache[d].name;return}a.typeahead_root_id=void 0};
a.cache_entities=function(b){if(b){b.hasOwnProperty("type.object.name.en")&&b.hasOwnProperty("_xid_")&&a.found_entity({name:b["type.object.name.en"],xid:b._xid_});b.hasOwnProperty("type.object.name.en")&&b.hasOwnProperty("_uid_")&&a.found_entity({name:b["type.object.name.en"],uid:b._uid_});for(var c in b)if(b.hasOwnProperty(c))if(b[c]instanceof Array)for(var d=0;d<b[c].length;d++)a.cache_entities(b[c][d]);else b[c]instanceof Object&&a.cache_entities(b[c])}};a.runQuery=function(b){var c=Date.now();
a.lastSentVersion=a.lastSentVersion||0;var d=++a.lastSentVersion;f({url:"https://dgraph.io/query",method:"POST",data:b}).then(function(b){d==a.lastSentVersion&&(a.had_network_error=!1,a.lastReceivedVersion=d,a.query_result=b.data.debug,a.json_result=JSON.stringify(a.query_result,null,2),a.cache_entities(a.query_result),a.latency_data=b.data.server_latency||{},a.latency_data.client_total_latency=Date.now()-c,a.latency_data.entity_count=a.json_result?a.json_result.replace(/"_uid_": /g,'"_uid_": 1').length-
a.json_result.length:0)},function(b){console.log(b);a.had_network_error=!0})}}]);
angular.module("darthGraph").directive("tree",["$compile",function(a){return{restrict:"E",scope:{obj:"=",expanded:"="},templateUrl:"tree_node.html",compile:function(f,b){var c=f.contents().remove(),d;return function(b,f,g){d||(d=a(c));d(b,function(a,b){f.append(a)});b.$watch("obj",function(a){b.fields=b.get_fields(a);b.summary=b.get_summary(a,b.fields)});b.$on("force_expand",function(){b.expanded=!0;for(var a=0;a<b.fields.length;a++)b.fields[a].expanded=!0});b.expand_all=function(){b.expanded=!0;
b.$broadcast("force_expand")};b.get_fields=function(a){var b=[],c;for(c in a){if(100<b.length)break;a.hasOwnProperty(c)&&("string"==typeof a[c]||"number"==typeof a[c]||null===a[c]||void 0===a[c]?b.push({key:c,value:a[c]}):a[c]instanceof Array?b.push({key:c,array:a[c]}):b.push({key:c,subobj:a[c]}))}return b};b.get_summary=function(a,b){if(null===a||void 0===a)return{title:"<n/a>",fields:[],children:0};for(var c=0,d=a._uid_,e=0;e<b.length;e++)b[e].subobj?c++:b[e].array&&(c+=b[e].array.length),0==b[e].key.indexOf("type.object.name.")&&
(d=b[e].value);return{title:d,fields:b.length,children:c}}}}}}]);